#!/bin/bash

if [[ -n $(git status -s --porcelain) ]]
then
  echo "Changes not pushed to preview, you have working changes in your working copy."
  exit 1
fi

# The tag name is preview-DATETIME.  This is not in a standard ISO format
# due to tag name restrictions.
BRANCH=$(git rev-parse --abbrev-ref HEAD) 
SHA1=$(git rev-parse HEAD)
TAG="preview-$(date -u +"%Y%m%d%H%M%SZ")"
git tag $TAG || { echo "Could not create tag $tag"; exit 1; }
git push --quiet origin $TAG || { echo "Cound not push tag $tag to origin"; exit 1; }

# Move the tag to preview
git push --quiet --force origin $TAG:preview || { echo "Could not push tag $tag to origin/preview"; exit 1; }

RESULT="
Preview successfully updated.
  source branch: $BRANCH
  SHA1: $SHA1
  tag: $TAG
"
echo "$RESULT"

exit 0;
